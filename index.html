<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Rocket</title>
    <!-- Carrega o TailwindCSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones (Lucide) --><script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide.min.js"></script>
    
    <style>
        /* CSS mínimo para a aplicação */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Oculta as telas inativas */
        .page { /* Containers principais: auth vs app */
            display: none;
        }
        .page.active {
            display: block;
        }
        
        .page-content { /* Áreas de conteúdo dentro do app */
            display: none;
        }
        .page-content.active {
            display: block;
        }

        .modal { /* Modais (pop-ups) */
            display: none; /* Oculto por padrão */
        }
        .modal.active {
            display: flex; /* Visível quando ativo (Tailwind usa flex) */
        }
        
        .hidden {
            display: none;
        }

        /* Estilo para o "fantasma" do drag-and-drop */
        .dragging {
            opacity: 0.5;
            background: #fffbeb; /* Amarelo clarinho */
            border: 2px dashed #fbbf24; /* Amarelo */
        }
        .drag-over {
            background-color: #fffbeb; /* Amarelo clarinho */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Estilo para botões desabilitados */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- TELA DE LOGIN (AGORA TELA DE CARREGAMENTO) --><div id="auth-page" class="page active">
        <div class="flex min-h-screen items-center justify-center bg-gray-950 text-white p-4">
            <div class="w-full max-w-md bg-gray-900 p-8 rounded-lg shadow-xl text-center">
                <h1 class="text-3xl font-bold text-yellow-400 text-center mb-2">CRM Rocket</h1>
                <p class="text-center text-gray-400 mb-6">Carregando seus dados...</p>
                <div id="authError" class="text-red-400 text-center text-sm mt-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL (CRM) --><div id="app-page" class="page">
        <div class="flex h-screen bg-gray-100">
            <!-- MENU LATERAL (SIDEBAR) --><aside class="w-64 bg-gray-950 text-white flex flex-col p-4">
                <div class="bg-white p-4 rounded-lg mb-8">
                    <img src="https://i.postimg.cc/jjgT3jhJ/logo.png" alt="Logo da Empresa" class="w-auto h-12 mx-auto" onerror="this.src='https://placehold.co/200x50/ffffff/333333?text=Logo'; this.onerror=null;">
                </div>

                <nav class="flex-1 space-y-2">
                    <button data-page="dashboardPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </button>
                    <button data-page="prospectsPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="kanban-square"></i>
                        <span>Prospecção</span>
                    </button>
                    <button data-page="clientsPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="users"></i>
                        <span>Clientes</span>
                    </button>
                    <button data-page="financialReportPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="dollar-sign"></i>
                        <span>Financeiro</span>
                    </button>
                    <button data-page="globalTasksPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="check-square"></i>
                        <span>Tarefas Globais</span>
                    </button>
                    <button data-page="companyPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="target"></i>
                        <span>Minha Empresa</span>
                    </button>
                    <!-- REMOVIDO: Assistente IA 
                    <button data-page="aiAssistantPage" class="nav-link flex items-center gap-3 w-full p-3 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors">
                        <i data-lucide="sparkles"></i>
                        <span>Assistente IA</span>
                    </button>
                    -->
                </nav>

                <div class="mt-auto">
                </div>
            </aside>

            <!-- CONTEÚDO PRINCIPAL --><main class="flex-1 overflow-y-auto p-8">

                <!-- TELA 1: DASHBOARD --><div id="dashboardPage" class="page-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                    
                    <!-- KPIs --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-sm font-medium text-gray-500 uppercase">Clientes Ativos</h3>
                            <p id="kpi-ativos" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-sm font-medium text-gray-500 uppercase">Receita Recorrente (MRR)</h3>
                            <p id="kpi-mrr" class="text-3xl font-bold text-gray-900 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-sm font-medium text-gray-500 uppercase">Vendas Novas (Mês)</h3>
                            <p id="kpi-vendas-novas" class="text-3xl font-bold text-gray-900 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-sm font-medium text-gray-500 uppercase">Upsell (Mês)</h3>
                            <p id="kpi-upsell" class="text-3xl font-bold text-gray-900 mt-2">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- Alertas --><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Contratos Vencendo (30 dias)</h3>
                            <div id="alertas-contratos" class="space-y-3 max-h-48 overflow-y-auto">
                                <p class="text-gray-500">Nenhum contrato vencendo.</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pagamentos Vencendo (7 dias)</h3>
                            <div id="alertas-pagamentos" class="space-y-3 max-h-48 overflow-y-auto">
                                <p class="text-gray-500">Nenhum pagamento vencendo esta semana.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Progresso do Mês --><div class="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Progresso do Mês</h3>
                        <div class="space-y-6">
                            <!-- Faturamento --><div>
                                <div class="flex justify-between items-end mb-1">
                                    <span class="text-sm font-medium text-gray-700">Faturamento</span>
                                    <span id="faturamento-label-dash" class="text-sm font-medium text-gray-900">R$ 0,00 / R$ 0,00</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="faturamento-progress-dash" class="bg-yellow-500 h-4 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- Prospecção --><div>
                                <div class="flex justify-between items-end mb-1">
                                    <span class="text-sm font-medium text-gray-700">Novos Clientes</span>
                                    <span id="prospeccao-label-dash" class="text-sm font-medium text-gray-900">0 / 0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="prospeccao-progress-dash" class="bg-yellow-500 h-4 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TELA 2: PROSPECÇÃO (KANBAN) --><div id="prospectsPage" class="page-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Funil de Prospecção</h2>
                        <button id="showAddProspectModalBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="plus"></i>
                            <span>Novo Prospect</span>
                        </button>
                    </div>
                    
                    <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5">
                    </div>
                </div>

                <!-- TELA 3: CLIENTES (LISTA) --><div id="clientsPage" class="page-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Todos os Clientes</h2>
                        <button id="showAddClientModalBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="user-plus"></i>
                            <span>Novo Cliente</span>
                        </button>
                    </div>
                    <div class="bg-white shadow-md rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Término do Contrato</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clients-list-table" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TELA 4: DETALHE DO CLIENTE --><div id="clientDetailPage" class="page-content">
                    <button data-page="clientsPage" class="nav-link text-yellow-600 hover:text-yellow-800 font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="arrow-left"></i>
                        Voltar para Clientes
                    </button>
                    
                    <!-- Header do Cliente --><div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 id="detail-client-name" class="text-3xl font-bold text-gray-800">Nome do Cliente</h2>
                                <p id="detail-client-phone" class="text-gray-600 mt-1"></p>
                            </div>
                            <button id="editClientBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                                <i data-lucide="edit-2"></i>
                                <span>Editar</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mt-6 border-t pt-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 uppercase">Status</h4>
                                <p id="detail-client-status" class="text-lg font-semibold text-green-600">Ativo</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 uppercase">Valor do Projeto</h4>
                                <p id="detail-client-value" class="text-lg font-semibold text-gray-800">R$ 0,00</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 uppercase">Dias Restantes</h4>
                                <p id="detail-client-days" class="text-lg font-semibold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Abas de Detalhes --><div class="mb-6 border-b border-gray-200">
                        <nav class="flex space-x-8" aria-label="Tabs">
                            <button data-tab="financial" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-yellow-500 text-yellow-500">Financeiro</button>
                            <button data-tab="tasks" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Tarefas</button>
                            <button data-tab="credentials" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Senhas</button>
                        </nav>
                    </div>

                    <!-- Conteúdo das Abas --><div id="financialTab" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Histórico de Pagamentos</h3>
                                <div id="payments-list" class="space-y-3 max-h-96 overflow-y-auto">
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Adicionar Serviço (Upsell)</h3>
                                <form id="addPaymentForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Descrição do Serviço</label>
                                        <input type="text" id="paymentDesc" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Consultoria SEO" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                        <input type="number" step="0.01" id="paymentValue" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Data Vencimento</label>
                                        <input type="date" id="paymentDueDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div class="flex items-center pt-2">
                                        <input type="checkbox" id="paymentIsUpsell" class="h-4 w-4 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" checked>
                                        <label for="paymentIsUpsell" class="ml-2 block text-sm text-gray-700">Registrar como Venda (Upsell)</label>
                                    </div>
                                    <button type="submit" class="w-full p-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-semibold">Adicionar Serviço</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tasksTab" class="tab-content hidden">
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Checklist de Tarefas</h3>
                                <div id="tasks-list" class="space-y-3">
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nova Tarefa</h3>
                                <form id="addTaskForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Descrição</label>
                                        <input type="text" id="taskDesc" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <button type="submit" class="w-full p-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-semibold">Adicionar Tarefa</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div id="credentialsTab" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Credenciais e Senhas</h3>
                                <div id="credentials-list" class="space-y-3">
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Nova Credencial</h3>
                                <form id="addCredentialForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Serviço</label>
                                        <input type="text" id="credService" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Hospedagem, Google" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Login</label>
                                        <input type="text" id="credLogin" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Senha</label>
                                        <input type="text" id="credPassword" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                                    </div>
                                    <button type="submit" class="w-full p-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-semibold">Salvar Senha</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TELA 5: RELATÓRIO FINANCEIRO --><div id="financialReportPage" class="page-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Relatório Financeiro</h2>

                    <div class="mb-6 border-b border-gray-200">
                        <nav class="flex space-x-8" aria-label="Tabs">
                            <button data-tab="accountsReceivable" class="finance-tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-yellow-500 text-yellow-500">Contas a Receber</button>
                            <button data-tab="paidThisMonth" class="finance-tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Pagos (Mês Atual)</button>
                        </nav>
                    </div>

                    <div id="accountsReceivableTab" class="finance-tab-content">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Pagamentos Atrasados</h3>
                                <div id="late-payments-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500">Nenhum pagamento atrasado.</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Pagamentos Previstos</h3>
                                <div id="upcoming-payments-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500">Nenhum pagamento previsto.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="paidThisMonthTab" class="finance-tab-content hidden">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pagamentos Confirmados (Mês Atual)</h3>
                            <div id="paid-this-month-list" class="space-y-3 max-h-96 overflow-y-auto">
                                <p class="text-gray-500">Nenhum pagamento registrado como pago este mês.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TELA 6: TAREFAS GLOBAIS --><div id="globalTasksPage" class="page-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Todas as Tarefas</h2>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold text-gray-800">Checklist Completo</h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <select id="globalTaskClientFilter" class="p-2 border border-gray-300 rounded-md text-sm w-full">
                                    <option value="all">Todos os Clientes</option>
                                </select>
                                <select id="globalTaskStatusFilter" class="p-2 border border-gray-300 rounded-md text-sm w-full">
                                    <option value="all">Todos os Status</option>
                                    <option value="A Fazer">A Fazer</option>
                                    <option value="Feito">Feito</option>
                                </select>
                            </div>
                        </div>
                        <div id="global-tasks-list" class="space-y-3 max-h-[calc(100vh-280px)] overflow-y-auto">
                            <p class="text-gray-500">Nenhuma tarefa encontrada.</p>
                        </div>
                    </div>
                </div>

                <!-- TELA 7: MINHA EMPRESA (METAS) --><div id="companyPage" class="page-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Metas da Empresa</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Definir Metas Mensais</h3>
                            <form id="goalsForm" class="space-y-4">
                                <div>
                                    <label for="goal-faturamento" class="block text-sm font-medium text-gray-700">Meta de Faturamento (R$)</label>
                                    <input type="number" id="goal-faturamento" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="20000">
                                </div>
                                <div>
                                    <label for="goal-prospeccao" class="block text-sm font-medium text-gray-700">Meta de Prospecção (Novos Clientes)</label>
                                    <input type="number" id="goal-prospeccao" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="5">
                                </div>
                                <button type="submit" class="w-full p-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md font-semibold">Salvar Metas</button>
                            </form>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Progresso do Mês</h3>
                            <div class="space-y-6">
                                <div>
                                    <div class="flex justify-between items-end mb-1">
                                        <span class="text-sm font-medium text-gray-700">Faturamento</span>
                                        <span id="faturamento-label" class="text-sm font-medium text-gray-900">R$ 0,00 / R$ 0,00</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="faturamento-progress" class="bg-yellow-500 h-4 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-end mb-1">
                                        <span class="text-sm font-medium text-gray-700">Novos Clientes</span>
                                        <span id="prospeccao-label" class="text-sm font-medium text-gray-900">0 / 0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="prospeccao-progress" class="bg-yellow-500 h-4 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TELA 8: ASSISTENTE IA (REMOVIDA) 
                <div id="aiAssistantPage" class="page-content">
                </div>
                -->

            </main>
        </div>
    </div>

    <!-- MODAL: Adicionar/Editar Cliente --><div id="clientModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div class="p-6">
                    <h3 id="clientModalTitle" class="text-xl font-semibold text-gray-800 mb-4">Novo Cliente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                            <input type="text" id="clientNameInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Telefone</label>
                            <input type="tel" id="clientPhoneInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data Início</label>
                            <input type="date" id="clientStartDateInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Data Término</label>
                            <input type="date" id="clientEndDateInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor Total (Projeto)</label>
                            <input type="number" step="0.01" id="clientValueInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="clientStatusInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                                <option value="Pausado">Pausado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de Pagamento</label>
                            <select id="clientPaymentTypeInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="unico">Valor Único</option>
                                <option value="parcelado">Parcelado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nº de Parcelas</label>
                            <input type="number" id="clientInstallmentsInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: 12" disabled>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end gap-3">
                    <button type="button" id="closeClientModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Adicionar Prospect --><div id="prospectModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <form id="prospectForm">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Novo Prospect</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nome</label>
                            <input type="text" id="prospectNameInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="prospectEmailInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Origem</label>
                            <input type="text" id="prospectOriginInput" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: LinkedIn, Indicação">
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end gap-3">
                    <button type="button" id="closeProspectModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg">Salvar Prospect</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Confirmação de Exclusão --><div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i>
                <h3 class="text-lg font-medium text-gray-900 mt-4">Confirmar Exclusão</h3>
                <p id="deleteModalText" class="text-sm text-gray-500 mt-2">Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="bg-gray-50 p-4 flex justify-center gap-3">
                <button type="button" id="cancelDeleteBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Excluir</button>
            </div>
        </div>
    </div>


    <!-- Scripts do Firebase e da Aplicação --><script type="module">
        // Importações do Firebase (ESM - Módulos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            getDocs,
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS DE AMBIENTE (INJETADAS) ---
        // CORREÇÃO: Usamos um ID estático (namespace) para o banco de dados,
        // já que estamos usando o Firebase do usuário, não o do Canvas.
        const appId = 'crm-rocket-data'; 
        
        // --- CHAVES DO FIREBASE INSERIDAS DIRETAMENTE ---
        // Alterado conforme solicitado, para forçar a conexão sem o painel de Configurações.
        const firebaseConfig = {
          apiKey: "AIzaSyCjOOO8BjKHSl_4a8yU9Y6ggyVsKvIdT00",
          authDomain: "crmrocket.firebaseapp.com",
          projectId: "crmrocket",
          storageBucket: "crmrocket.firebasestorage.app",
          messagingSenderId: "395158203315",
          appId: "1:395158203315:web:93adeda54e40734d1c39c6"
        };
        
        // Esta variável não será usada, pois usaremos o login anônimo do 'crmrocket'
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- INICIALIZAÇÃO DO FIREBASE ---
        let app, auth, db;
        try {
            // Verifica se o firebaseConfig não está vazio
            if (!firebaseConfig.apiKey) {
                throw new Error("API Key do Firebase está faltando.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
            // Mostra o erro na tela de carregamento
            const authError = document.getElementById('authError');
            if(authError) {
                authError.textContent = `Erro ao inicializar Firebase: ${e.message}. Verifique as chaves no código.`;
                authError.classList.remove('hidden');
            } else {
                 document.body.innerHTML = `<h1 style='text-align: center; margin-top: 50px;'>Erro de Configuração do Firebase: ${e.message}. Verifique o console.</h1>`;
            }
        }

        // --- ESTADO GLOBAL DA APLICAÇÃO ---
        let userId = null; 
        let currentClientId = null; 
        let currentDeleteInfo = null; 
        let draggedProspectId = null; 
        let allClientsData = {}; 

        // --- FUNÇÕES DE UTILIDADE ---

        const renderIcons = () => {
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (e) {
                    console.error("Erro ao renderizar ícones lucide:", e);
                }
            } else {
                console.warn("Lucide ainda não definido, ícones podem demorar a aparecer.");
            }
        };

        const formatCurrency = (value) => {
            return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const getDaysRemaining = (dateStr) => {
            if (!dateStr) return 0;
            const today = new Date();
            const endDate = new Date(dateStr + "T23:59:59"); 
            const diffTime = endDate.getTime() - today.getTime();
            return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const cleanDateStr = dateStr.split('T')[0];
            const [year, month, day] = cleanDateStr.split('-');
            return `${day}/${month}/${year}`;
        };

        const showPage = (pageId) => {
            document.querySelectorAll('.page-content, #auth-page, #app-page').forEach(page => {
                page.classList.remove('active');
            });

            if (pageId === 'auth-page') {
                document.getElementById('auth-page').classList.add('active');
            } else {
                document.getElementById('app-page').classList.add('active');
                if (document.getElementById(pageId)) {
                    document.getElementById(pageId).classList.add('active');
                } else {
                    document.getElementById('dashboardPage').classList.add('active'); 
                }
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('bg-gray-700', link.dataset.page === pageId);
            });
            
            switch(pageId) {
                case 'dashboardPage': loadDashboardData(); break;
                case 'prospectsPage': loadProspects(); break;
                case 'clientsPage': loadClientsList(); break;
                case 'financialReportPage': loadFinancialReport(); break;
                case 'globalTasksPage': loadGlobalTasks(); break; 
                case 'companyPage': loadCompanyGoalsPage(); break;
                // REMOVIDO:
                // case 'aiAssistantPage': loadAIPage(); break;
            }
        };
        
        const showModal = (modalId) => {
            document.getElementById(modalId)?.classList.add('active');
        };

        const hideModal = (modalId) => {
            document.getElementById(modalId)?.classList.remove('active');
        };
        
        const switchTab = (tabName, tabContainerClass, contentContainerClass) => {
            document.querySelectorAll(contentContainerClass).forEach(content => {
                content.classList.toggle('hidden', content.id !== `${tabName}Tab`);
            });
            document.querySelectorAll(tabContainerClass).forEach(link => {
                link.classList.toggle('border-yellow-500', link.dataset.tab === tabName);
                link.classList.toggle('text-yellow-500', link.dataset.tab === tabName);
                link.classList.toggle('border-transparent', link.dataset.tab !== tabName);
                link.classList.toggle('text-gray-500', link.dataset.tab !== tabName);
            });
        };

        // NOVA FUNÇÃO: Trata erros amigáveis
        const handleFriendlyError = (title, message, error) => {
            console.error(title, error || message); // Loga o erro original no console
            const authPage = document.getElementById('auth-page');
            const authError = document.getElementById('authError');

            // Verifica se o erro é de permissão
            if (message.includes("Missing or insufficient permissions")) {
                 title = "Erro de Permissão do Banco de Dados.";
                 message = "Suas 'Regras' do Firestore estão bloqueando o app. Por favor, vá em 'Cloud Firestore' > 'Regras', cole o texto abaixo e clique em 'Publicar':\n\n<pre class='text-left text-xs bg-gray-800 p-2 rounded'>rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /artifacts/crm-rocket-data/public/data/{document=**} {\n      allow read, write: if request.auth != null;\n    }\n    match /artifacts/crm-rocket-data/users/{userId}/{document=**} {\n      allow read, write: if request.auth != null && request.auth.uid == userId;\n    }\n  }\n}</pre>";
            }
            // Verifica se o erro é de client offline (Firestore não ativado)
            else if (message.includes("offline") || message.includes("Failed to get document")) {
                 title = "Erro de Banco de Dados: Client Offline.";
                 message = "Isso geralmente significa que o 'Cloud Firestore' não foi ativado no seu projeto Firebase. Por favor, vá ao painel do Firebase, clique em 'Cloud Firestore', 'Criar banco de dados' e escolha 'Modo de Teste'.";
            }
             // Verifica se o erro é de config de auth (Anônimo não ativado)
            else if (message.includes("auth/configuration-not-found")) {
                title = "Falha no Login: Configuração não encontrada.";
                message = "Isso significa que você ativou a 'Autenticação' no Firebase, mas esqueceu de ativar o provedor 'Anônimo'. Por favor, vá em 'Authentication' > 'Método de Login' > 'Adicionar provedor' e ative 'Anônimo'.";
            }


            if (authPage && authError) {
                authError.innerHTML = `
                    <strong class="text-lg">${title}</strong><br>
                    <span class="text-sm">${message}</span>
                `;
                authError.classList.remove('hidden');
                authError.classList.add('text-left', 'bg-red-900', 'p-4', 'rounded-md');
                showPage('auth-page'); // Volta para a tela de erro
            }
        };

        // --- AUTENTICAÇÃO ---
        
        // Verifica se 'auth' foi inicializado antes de usar
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; // IMPORTANTE: userId agora é usado para REGRAS de segurança
                    initEventListeners();
                    await loadAllClientsToCache();
                    showPage('dashboardPage'); 
                } else {
                    userId = null;
                    autoLogin();
                }
            }, (error) => {
                handleFriendlyError("Erro na Autenticação", error.message, error);
            });
        }

        const autoLogin = async () => {
             if (!auth) {
                 console.error("Autenticação do Firebase não inicializada.");
                 return;
             }
             try {
                // CORREÇÃO: Força o login anônimo sempre, 
                // já que estamos usando o Firebase do usuário (crmrocket)
                // e ativamos o provedor "Anônimo" lá.
                await signInAnonymously(auth);
                
            } catch (error) {
                console.error("Falha no login automático: ", error);
                // O handler de erro agora é chamado pela função principal
                handleFriendlyError("Falha no login automático", error.message, error);
            }
        };

        // --- METAS (Definição) ---
        
        // CORREÇÃO: Caminho do DB mudou para PÚBLICO
        const goalsDocRef = () => doc(db, `/artifacts/${appId}/public/data/company/goals`);
        
        const loadCompanyGoalsData = async () => {
            if (!userId || !db) return;

            let metaFaturamento = 0;
            let metaProspeccao = 0;
            try {
                const docSnap = await getDoc(goalsDocRef());
                if (docSnap.exists()) {
                    const goals = docSnap.data();
                    metaFaturamento = goals.faturamento || 0;
                    metaProspeccao = goals.prospeccao || 0;
                }
            } catch (e) { 
                // CORREÇÃO: Chama o handler de erro amigável
                handleFriendlyError("Erro ao carregar metas", e.message, e);
                return; // Para a execução se não puder carregar
            }

            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                const salesQuery = query(collection(db, `/artifacts/${appId}/public/data/sales`), where("data", ">=", new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]));
                let faturamentoAtual = 0;
                let novosClientes = 0;

                const salesSnapshot = await getDocs(salesQuery);
                salesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    faturamentoAtual += sale.valor || 0;
                    if (sale.tipo === 'Novo Contrato') {
                        novosClientes++;
                    }
                });

                // Atualiza UI (Página Minha Empresa)
                const fLabel = document.getElementById('faturamento-label');
                const fProgress = document.getElementById('faturamento-progress');
                const pLabel = document.getElementById('prospeccao-label');
                const pProgress = document.getElementById('prospeccao-progress');

                if (fLabel && fProgress && pLabel && pProgress) {
                    const fPercent = metaFaturamento > 0 ? (faturamentoAtual / metaFaturamento) * 100 : 0;
                    fLabel.textContent = `${formatCurrency(faturamentoAtual)} / ${formatCurrency(metaFaturamento)}`;
                    fProgress.style.width = `${Math.min(fPercent, 100)}%`;
                    
                    const pPercent = metaProspeccao > 0 ? (novosClientes / metaProspeccao) * 100 : 0;
                    pLabel.textContent = `${novosClientes} / ${metaProspeccao}`;
                    pProgress.style.width = `${Math.min(pPercent, 100)}%`;
                }

                // Atualiza UI (Dashboard)
                const fLabelDash = document.getElementById('faturamento-label-dash');
                const fProgressDash = document.getElementById('faturamento-progress-dash');
                const pLabelDash = document.getElementById('prospeccao-label-dash');
                const pProgressDash = document.getElementById('prospeccao-progress-dash');

                if (fLabelDash && fProgressDash && pLabelDash && pProgressDash) {
                    const fPercent = metaFaturamento > 0 ? (faturamentoAtual / metaFaturamento) * 100 : 0;
                    fLabelDash.textContent = `${formatCurrency(faturamentoAtual)} / ${formatCurrency(metaFaturamento)}`;
                    fProgressDash.style.width = `${Math.min(fPercent, 100)}%`;
                    
                    const pPercent = metaProspeccao > 0 ? (novosClientes / metaProspeccao) * 100 : 0;
                    pLabelDash.textContent = `${novosClientes} / ${metaProspeccao}`;
                    pProgressDash.style.width = `${Math.min(pPercent, 100)}%`;
                }
            } catch (e) {
                handleFriendlyError("Erro ao carregar dados de vendas", e.message, e);
            }
        };

        const loadCompanyGoalsPage = async () => {
            if (!userId) return;

            try {
                const docSnap = await getDoc(goalsDocRef());
                if (docSnap.exists()) {
                    const goals = docSnap.data();
                    document.getElementById('goal-faturamento').value = goals.faturamento || 0;
                    document.getElementById('goal-prospeccao').value = goals.prospeccao || 0;
                }
            } catch (e) { 
                handleFriendlyError("Erro ao carregar página de metas", e.message, e);
            }

            loadCompanyGoalsData();
        };


        // --- DASHBOARD ---

        const loadDashboardData = () => {
            if (!userId || !db) return;

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const clientsQuery = query(collection(db, `/artifacts/${appId}/public/data/clients`), where("status", "==", "Ativo"));
            onSnapshot(clientsQuery, (snapshot) => {
                let ativos = 0;
                let mrr = 0;
                snapshot.forEach(doc => {
                    ativos++;
                    mrr += (doc.data().monthlyValue || 0); 
                });
                document.getElementById('kpi-ativos').textContent = ativos;
                document.getElementById('kpi-mrr').textContent = formatCurrency(mrr);
            }, (e) => { handleFriendlyError("Erro no Dashboard (Clientes)", e.message, e); });

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const salesQuery = query(collection(db, `/artifacts/${appId}/public/data/sales`), where("data", ">=", new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]));
            onSnapshot(salesQuery, (snapshot) => {
                let vendasNovas = 0;
                let upsell = 0;
                snapshot.forEach(doc => {
                    const sale = doc.data();
                    if (sale.tipo === 'Novo Contrato') {
                        vendasNovas += sale.valor || 0;
                    } else if (sale.tipo === 'Upsell') {
                        upsell += sale.valor || 0;
                    }
                });
                document.getElementById('kpi-vendas-novas').textContent = formatCurrency(vendasNovas);
                document.getElementById('kpi-upsell').textContent = formatCurrency(upsell);
            }, (e) => { handleFriendlyError("Erro no Dashboard (Vendas)", e.message, e); });

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const contractsQuery = query(collection(db, `/artifacts/${appId}/public/data/clients`), where("status", "==", "Ativo"));
            onSnapshot(contractsQuery, (snapshot) => {
                const container = document.getElementById('alertas-contratos');
                container.innerHTML = '';
                let hasAlert = false;
                snapshot.forEach(doc => {
                    const client = doc.data();
                    const days = getDaysRemaining(client.dataTermino);
                    if (days <= 30) {
                        hasAlert = true;
                        container.innerHTML += `
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-md">
                                <div>
                                    <p class="font-semibold text-yellow-800">${client.nome}</p>
                                    <p class="text-sm text-yellow-600">Vence em ${days} dias (${formatDate(client.dataTermino)})</p>
                                </div>
                                <button onclick="window.handleViewClient('${doc.id}')" class="text-sm text-yellow-600 hover:underline">Ver</button>
                            </div>
                        `;
                    }
                });
                if (!hasAlert) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum contrato vencendo.</p>';
                }
            }, (e) => { handleFriendlyError("Erro no Dashboard (Contratos)", e.message, e); });
            
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const paymentsQuery = query(collection(db, `/artifacts/${appId}/public/data/payments`), 
                where("status", "==", "Pendente")
            );
            onSnapshot(paymentsQuery, async (snapshot) => {
                const container = document.getElementById('alertas-pagamentos');
                container.innerHTML = '';
                let hasAlert = false; 
                
                const today = new Date().toISOString().split('T')[0];
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                const nextWeekStr = nextWeek.toISOString().split('T')[0];
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum pagamento pendente registrado.</p>';
                    return;
                }
                
                for (const docSnap of snapshot.docs) {
                    const payment = docSnap.data();
                    const dueDate = payment.dataVencimento;
                    
                    if (dueDate >= today && dueDate <= nextWeekStr) {
                        hasAlert = true; 
                        const clientName = allClientsData[payment.clientId]?.nome || "Cliente...";
                        container.innerHTML += `
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-md">
                                <div>
                                    <p class="font-semibold text-yellow-800">${clientName}</p>
                                    <p class="text-sm text-yellow-600">${payment.descricao} - ${formatCurrency(payment.valor)}</p>
                                </div>
                                <button onclick="window.handleViewClient('${payment.clientId}')" class="text-sm text-yellow-600 hover:underline">Ver</button>
                            </div>
                        `;
                    }
                }
                
                if (!hasAlert) {
                    container.innerHTML = '<p class="text-gray-500">Nenhum pagamento vencendo esta semana.</p>';
                }
            }, (e) => { handleFriendlyError("Erro no Dashboard (Pagamentos)", e.message, e); });

            loadCompanyGoalsData();
        };
        
        // --- CLIENTES (CRUD) ---
        
        const loadAllClientsToCache = async () => {
            if (!userId || !db) return;
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const q = query(collection(db, `/artifacts/${appId}/public/data/clients`));
            onSnapshot(q, (snapshot) => {
                allClientsData = {}; 
                snapshot.forEach(doc => {
                    allClientsData[doc.id] = { id: doc.id, ...doc.data() };
                });
            }, (e) => { handleFriendlyError("Erro Crítico: Falha ao carregar cache de clientes.", e.message, e); });
        };

        const loadClientsList = () => {
            if (!userId || !db) return;
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const q = query(collection(db, `/artifacts/${appId}/public/data/clients`));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('clients-list-table');
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-gray-500">Nenhum cliente cadastrado.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const client = doc.data();
                    const statusColor = client.status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <p class="text-sm font-semibold text-gray-900">${client.nome}</p>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${client.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(client.dataTermino)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button onclick="window.handleViewClient('${doc.id}')" class="text-yellow-600 hover:text-yellow-800">Ver Detalhes</button>
                                <button onclick="window.handleDeleteClick('clients', '${doc.id}')" class="text-red-600 hover:text-red-800">Excluir</button>
                            </td>
                        </tr>
                    `;
                });
            }, (e) => { handleFriendlyError("Erro ao carregar lista de clientes.", e.message, e); });
        };
        
        const openClientModal = async (clientId = null, initialData = null) => {
            const form = document.getElementById('clientForm');
            form.reset();
            document.getElementById('clientId').value = '';
            
            document.getElementById('clientPaymentTypeInput').disabled = false;
            document.getElementById('clientInstallmentsInput').disabled = true;
            document.getElementById('clientInstallmentsInput').required = false;

            if (clientId) {
                // Modo Edição
                document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                try {
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    const clientDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/clients/${clientId}`));
                    const data = clientDoc.data(); // Mova para fora do 'if' se 'data' for usado em 'disabled'
                    if (clientDoc.exists()) {
                        document.getElementById('clientId').value = clientId;
                        document.getElementById('clientNameInput').value = data.nome || '';
                        document.getElementById('clientPhoneInput').value = data.telefone || '';
                        document.getElementById('clientStartDateInput').value = data.dataInicio || '';
                        document.getElementById('clientEndDateInput').value = data.dataTermino || '';
                        document.getElementById('clientValueInput').value = data.valorTotal || 0;
                        document.getElementById('clientStatusInput').value = data.status || 'Ativo';
                    }
                    // Lógica movida para fora para sempre ser executada na edição
                    document.getElementById('clientPaymentTypeInput').value = (data && data.monthlyValue > 0) ? 'parcelado' : 'unico';
                    document.getElementById('clientPaymentTypeInput').disabled = true;
                    document.getElementById('clientInstallmentsInput').value = '';
                    document.getElementById('clientInstallmentsInput').disabled = true;

                } catch(e) { 
                    console.error("Erro ao abrir modal de cliente:", e); 
                    handleFriendlyError("Erro ao carregar dados do cliente.", e.message, e);
                }
            } else {
                // Modo Novo
                document.getElementById('clientModalTitle').textContent = 'Novo Cliente';
                if (initialData) {
                    document.getElementById('clientNameInput').value = initialData.nome || '';
                    document.getElementById('clientPhoneInput').value = initialData.telefone || ''; 
                }
            }
            showModal('clientModal');
        };

        const handleClientFormSubmit = async (e) => {
            e.preventDefault();
            if (!userId) return;

            // CORREÇÃO: Prevenir múltiplos envios
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = "Salvando...";
            
            const clientId = document.getElementById('clientId').value;
            const clientData = {
                nome: document.getElementById('clientNameInput').value,
                telefone: document.getElementById('clientPhoneInput').value,
                dataInicio: document.getElementById('clientStartDateInput').value,
                dataTermino: document.getElementById('clientEndDateInput').value,
                valorTotal: parseFloat(document.getElementById('clientValueInput').value),
                status: document.getElementById('clientStatusInput').value,
                ownerId: userId // Mantém o 'dono' para referência, mas o dado é público
            };
            const valorVenda = clientData.valorTotal;

            // *** CORREÇÃO: Lógica de 'monthlyValue' (Valor Mensal) ***
            let monthlyValue = 0;
            const paymentType = document.getElementById('clientPaymentTypeInput').value;
            const installments = parseInt(document.getElementById('clientInstallmentsInput').value) || 0;
            
            if (paymentType === 'parcelado' && installments > 0) {
                monthlyValue = parseFloat((clientData.valorTotal / installments).toFixed(2));
            }
            clientData.monthlyValue = monthlyValue;
            // *** Fim da Correção ***

            try {
                let savedClientId = clientId; 
                
                if (clientId) {
                    // Atualiza
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    const clientRef = doc(db, `/artifacts/${appId}/public/data/clients/${clientId}`);
                    // Ao editar, preserva o 'monthlyValue' original se a regra de parcelamento não estiver disponível
                    const oldDoc = await getDoc(clientRef);
                    clientData.monthlyValue = clientData.monthlyValue || (oldDoc.exists() ? oldDoc.data().monthlyValue : 0) || 0;
                    await updateDoc(clientRef, clientData);
                } else {
                    // Cria
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/clients`), clientData);
                    savedClientId = docRef.id; 
                    
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/sales`), {
                        tipo: 'Novo Contrato',
                        valor: valorVenda,
                        data: new Date().toISOString().split('T')[0], 
                        clientId: savedClientId,
                        ownerId: userId
                    });
                    
                    // Lógica de Parcelas
                    if (paymentType === 'parcelado' && installments > 0) {
                        const totalValue = clientData.valorTotal;
                        const installmentValue = monthlyValue; // Usa o valor mensal já calculado
                        const startDate = new Date(clientData.dataInicio + "T12:00:00"); 
                        
                        const batch = writeBatch(db);
                        
                        for (let i = 1; i <= installments; i++) {
                            const dueDate = new Date(startDate);
                            dueDate.setMonth(startDate.getMonth() + (i - 1)); 
                            
                            const paymentData = {
                                clientId: savedClientId,
                                descricao: `Parcela ${i} de ${installments}`,
                                valor: installmentValue,
                                dataVencimento: dueDate.toISOString().split('T')[0], 
                                status: 'Pendente',
                                ownerId: userId
                            };
                            
                            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                            const newPaymentRef = doc(collection(db, `/artifacts/${appId}/public/data/payments`));
                            batch.set(newPaymentRef, paymentData);
                        }
                        
                        await batch.commit(); 
                    }
                }
                
                hideModal('clientModal');
                
                if(currentClientId === savedClientId) { 
                    loadClientDetail(savedClientId); 
                }

            } catch (e) {
                console.error("Erro ao salvar cliente:", e);
                // Não usamos alert()
            } finally {
                // CORREÇÃO: Re-abilita o botão
                submitButton.disabled = false;
                submitButton.textContent = "Salvar Cliente";
            }
        };

        // --- DETALHE DO CLIENTE ---
        
        window.handleViewClient = (clientId) => {
            currentClientId = clientId;
            loadClientDetail(clientId);
            showPage('clientDetailPage');
            switchTab('financial', '.tab-link', '.tab-content'); 
        };
        
        const loadClientDetail = (clientId) => {
            if (!userId || !clientId || !db) return;
            
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const clientRef = doc(db, `/artifacts/${appId}/public/data/clients/${clientId}`);
            onSnapshot(clientRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    document.getElementById('detail-client-name').textContent = data.nome;
                    document.getElementById('detail-client-phone').textContent = data.telefone || 'N/A';
                    document.getElementById('detail-client-value').textContent = formatCurrency(data.valorTotal);
                    document.getElementById('detail-client-status').textContent = data.status;
                    document.getElementById('detail-client-days').textContent = getDaysRemaining(data.dataTermino) + ' dias';
                } else {
                    console.error("Cliente não encontrado");
                    showPage('clientsPage'); 
                }
            }, (e) => { handleFriendlyError("Erro ao carregar detalhe do cliente.", e.message, e); });
            
            loadClientPayments(clientId);
            loadClientTasks(clientId);
            loadClientCredentials(clientId);
        };
        
        // --- Financeiro (Detalhe Cliente) ---
        
        const loadClientPayments = (clientId) => {
            if (!userId || !db) return;
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const q = query(collection(db, `/artifacts/${appId}/public/data/payments`), where("clientId", "==", clientId));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('payments-list');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum pagamento registrado.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const statusColor = p.status === 'Pago' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    
                    let actionButton = '';
                    if (p.status === 'Pendente') {
                        actionButton = `<button onclick="window.markPaymentStatus('${doc.id}', 'Pago')" class="text-sm font-medium text-green-600 hover:text-green-800">Marcar como Pago</button>`;
                    } else {
                        actionButton = `<button onclick="window.markPaymentStatus('${doc.id}', 'Pendente')" class="text-sm font-medium text-gray-500 hover:text-gray-700">Desfazer</button>`;
                    }
                    
                    container.innerHTML += `
                        <div class="flex justify-between items-center p-4 border rounded-md hover:bg-gray-50">
                            <div>
                                <p class="font-semibold text-gray-800">${p.descricao}</p>
                                <p class="text-sm text-gray-600">${formatCurrency(p.valor)} - Venc: ${formatDate(p.dataVencimento)}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                    ${p.status}
                                </span>
                                ${actionButton}
                                <button onclick="window.handleDeleteClick('payments', '${doc.id}')" class="text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    `;
                });
                renderIcons();
            }, (e) => { handleFriendlyError("Erro ao carregar pagamentos.", e.message, e); });
        };
        
        window.markPaymentStatus = async (paymentId, newStatus) => {
            if (!userId || !db) return;
            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                const paymentRef = doc(db, `/artifacts/${appId}/public/data/payments/${paymentId}`);
                await updateDoc(paymentRef, { status: newStatus });
            } catch(e) {
                console.error("Erro ao atualizar status:", e);
            }
        };
        
        const handleAddPaymentSubmit = async (e) => {
            e.preventDefault();
            if (!userId || !db) return;
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = "Salvando...";

            const data = {
                clientId: currentClientId,
                descricao: document.getElementById('paymentDesc').value,
                valor: parseFloat(document.getElementById('paymentValue').value),
                dataVencimento: document.getElementById('paymentDueDate').value,
                status: 'Pendente',
                ownerId: userId
            };
            
            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                await addDoc(collection(db, `/artifacts/${appId}/public/data/payments`), data);
                
                const isUpsell = document.getElementById('paymentIsUpsell').checked;
                if (isUpsell) {
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/sales`), {
                        tipo: 'Upsell',
                        valor: data.valor,
                        data: new Date().toISOString().split('T')[0],
                        clientId: currentClientId,
                        ownerId: userId
                    });
                }
                
                document.getElementById('addPaymentForm').reset();
                document.getElementById('paymentIsUpsell').checked = true;
            } catch(e) { 
                console.error("Erro ao adicionar pagamento:", e);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Adicionar Serviço";
            }
        };
        
        // --- Tarefas (Detalhe Cliente) ---

        const loadClientTasks = (clientId) => {
             if (!userId || !db) return;
             // CORREÇÃO: Caminho do DB mudou para PÚBLICO
             const q = query(collection(db, `/artifacts/${appId}/public/data/tasks`), where("clientId", "==", clientId));
             onSnapshot(q, (snapshot) => {
                const container = document.getElementById('tasks-list');
                if (!container) return; 
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma tarefa registrada.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const isDone = task.status === 'Feito';
                    container.innerHTML += `
                        <div class="flex justify-between items-center p-4 border rounded-md ${isDone ? 'bg-gray-50' : ''}">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" onchange="window.toggleTaskStatus('${doc.id}', ${isDone})" ${isDone ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400">
                                <p class="${isDone ? 'line-through text-gray-500' : 'text-gray-800'}">${task.descricao}</p>
                            </div>
                            <button onclick="window.handleDeleteClick('tasks', '${doc.id}')" class="text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
                renderIcons();
             }, (e) => { handleFriendlyError("Erro ao carregar tarefas.", e.message, e); });
        };
        
        const handleAddTaskSubmit = async (e) => {
            e.preventDefault();
            if (!userId || !db) return;
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const desc = document.getElementById('taskDesc').value;
            if(!desc) {
                submitButton.disabled = false;
                return;
            }
            
            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                await addDoc(collection(db, `/artifacts/${appId}/public/data/tasks`), {
                    clientId: currentClientId,
                    descricao: desc,
                    status: 'A Fazer',
                    ownerId: userId
                });
                document.getElementById('addTaskForm').reset();
            } catch (e) {
                console.error("Erro ao adicionar tarefa:", e);
            } finally {
                submitButton.disabled = false;
            }
        };
        
        window.toggleTaskStatus = async (taskId, isDone) => {
            if (!userId || !db) return;
            const newStatus = isDone ? 'A Fazer' : 'Feito';
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            await updateDoc(doc(db, `/artifacts/${appId}/public/data/tasks/${taskId}`), { status: newStatus });
        };
        
        // --- Senhas (Detalhe Cliente) ---
        
        const loadClientCredentials = (clientId) => {
            if (!userId || !db) return;
            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const q = query(collection(db, `/artifacts/${appId}/public/data/credentials`), where("clientId", "==", clientId));
             onSnapshot(q, (snapshot) => {
                const container = document.getElementById('credentials-list');
                if (!container) return; 
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma credencial registrada.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const cred = doc.data();
                    container.innerHTML += `
                        <div class="p-4 border rounded-md">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold text-gray-800">${cred.servico}</h4>
                                <button onclick="window.handleDeleteClick('credentials', '${doc.id}')" class="text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            <div class="text-sm text-gray-600 mt-2">
                                <p><strong>Login:</strong> ${cred.login}</p>
                                <p><strong>Senha:</strong> <span id="pass-${doc.id}" data-pass="${cred.senha}">••••••••</span> 
                                    <button onclick="window.togglePassword('pass-${doc.id}')" class="ml-2 text-yellow-600 text-xs">(Mostrar)</button>
                                </p>
                            </div>
                        </div>
                    `;
                });
                renderIcons();
             }, (e) => { handleFriendlyError("Erro ao carregar credenciais.", e.message, e); });
        };
        
        const handleAddCredentialSubmit = async (e) => {
            e.preventDefault();
            if (!userId || !db) return;

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                await addDoc(collection(db, `/artifacts/${appId}/public/data/credentials`), {
                    clientId: currentClientId,
                    servico: document.getElementById('credService').value,
                    login: document.getElementById('credLogin').value,
                    senha: document.getElementById('credPassword').value,
                    ownerId: userId
                });
                document.getElementById('addCredentialForm').reset();
            } catch (e) {
                console.error("Erro ao adicionar credencial:", e);
            } finally {
                 submitButton.disabled = false;
            }
        };
        
        window.togglePassword = (elementId) => {
            const el = document.getElementById(elementId);
            const btn = el.nextElementSibling;
            if (el.textContent === '••••••••') {
                el.textContent = el.dataset.pass;
                btn.textContent = "(Ocultar)";
            } else {
                el.textContent = '••••••••';
                btn.textContent = "(Mostrar)";
            }
        };

        // --- PROSPECÇÃO (KANBAN) ---
        
        const KANBAN_COLUMNS = [
            { id: 'prospeccao', title: 'Prospecção' },
            { id: 'contato', title: 'Contato Feito' },
            { id: 'negociando', title: 'Negociando' },
            { id: 'fechado', title: 'Fechado' },
            { id: 'perdido', title: 'Perdido' }
        ];

        const loadProspects = () => {
            if (!userId || !db) return;
            
            const board = document.getElementById('kanban-board');
            board.innerHTML = '';
            KANBAN_COLUMNS.forEach(col => {
                board.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md p-4 h-full min-h-[200px]" 
                         id="kanban-col-${col.id}" 
                         data-status="${col.id}">
                        <h3 class="font-semibold text-gray-800 mb-4">${col.title}</h3>
                        <div id="kanban-cards-${col.id}" class="space-y-3 min-h-[100px]">
                        </div>
                    </div>
                `;
            });
            
            initDragAndDrop();

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const q = query(collection(db, `/artifacts/${appId}/public/data/prospects`));
            onSnapshot(q, (snapshot) => {
                document.querySelectorAll('[id^="kanban-cards-"]').forEach(col => col.innerHTML = '');
                
                if (snapshot.empty) {
                     document.getElementById('kanban-cards-prospeccao').innerHTML = '<p class="text-sm text-gray-400">Nenhum prospect.</p>';
                }
                
                snapshot.forEach(doc => {
                    const prospect = doc.data();
                    const statusId = prospect.status || 'prospeccao';
                    const container = document.getElementById(`kanban-cards-${statusId}`);
                    
                    if(container) {
                        let convertButton = '';
                        if (statusId === 'fechado') {
                            convertButton = `<button onclick="window.convertProspectToClient('${doc.id}')" class="text-xs text-yellow-600 hover:underline mt-2">Converter em Cliente</button>`;
                        }

                        container.innerHTML += `
                        <div class="p-3 border-2 bg-white rounded-md shadow-sm cursor-grab" 
                             draggable="true" 
                             data-id="${doc.id}" 
                             id="prospect-${doc.id}">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-semibold text-sm text-gray-800">${prospect.nome}</h4>
                                <button onclick="window.handleDeleteClick('prospects', '${doc.id}')" class="text-gray-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            <p class="text-sm text-gray-600">${prospect.email || 'Sem email'}</p>
                            <p class="text-xs text-gray-400 mt-2">Origem: ${prospect.origem || 'N/A'}</p>
                            ${convertButton}
                        </div>
                        `;
                    }
                });
                renderIcons();
                initCardDragListeners();
             }, (e) => { handleFriendlyError("Erro ao carregar prospects.", e.message, e); });
        };
        
        const handleProspectFormSubmit = async (e) => {
            e.preventDefault();
            if (!userId || !db) return;

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                await addDoc(collection(db, `/artifacts/${appId}/public/data/prospects`), {
                    nome: document.getElementById('prospectNameInput').value,
                    email: document.getElementById('prospectEmailInput').value,
                    origem: document.getElementById('prospectOriginInput').value,
                    status: 'prospeccao', 
                    ownerId: userId
                });
                hideModal('prospectModal');
                document.getElementById('prospectForm').reset();
            } catch (e) {
                console.error("Erro ao salvar prospect:", e);
            } finally {
                submitButton.disabled = false;
            }
        };
        
        function initCardDragListeners() {
            const cards = document.querySelectorAll('#kanban-board [draggable="true"]');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    // Verifique se o alvo é o card ou um filho dele
                    const targetCard = e.target.closest('[draggable="true"]');
                    if (targetCard) {
                        draggedProspectId = targetCard.dataset.id;
                        targetCard.classList.add('dragging');
                    }
                });
                
                card.addEventListener('dragend', (e) => {
                    const targetCard = e.target.closest('[draggable="true"]');
                    if (targetCard) {
                        targetCard.classList.remove('dragging');
                    }
                    draggedProspectId = null;
                });
            });
        }
        
        function initDragAndDrop() {
            const columns = document.querySelectorAll('#kanban-board [data-status]');
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Necessário para permitir o 'drop'
                    const targetColumn = e.target.closest('[data-status]');
                    if (targetColumn) {
                        targetColumn.classList.add('drag-over');
                    }
                });
                
                column.addEventListener('dragleave', (e) => {
                    const targetColumn = e.target.closest('[data-status]');
                    if (targetColumn) {
                        targetColumn.classList.remove('drag-over');
                    }
                });
                
                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (!userId || !db) return;
                    const targetColumn = e.target.closest('[data-status]');
                    if (!targetColumn) return;
                    
                    targetColumn.classList.remove('drag-over');
                    
                    if (!draggedProspectId) return;
                    
                    const newStatus = targetColumn.dataset.status;
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    const prospectRef = doc(db, `/artifacts/${appId}/public/data/prospects/${draggedProspectId}`);
                    
                    try {
                        await updateDoc(prospectRef, { status: newStatus });
                    } catch(err) {
                        console.error("Erro ao atualizar status do prospect:", err);
                    }
                    
                    draggedProspectId = null; // Limpa após o drop
                });
            });
        }
        
        // Corrigido: Passa os dados do prospect para a função de conversão
        window.convertProspectToClient = async (prospectId) => {
             if (!userId || !db) return;
             const prospectCard = document.getElementById(`prospect-${prospectId}`);
             if (!prospectCard) return;
             
             // Pega os dados do prospect diretamente do snapshot (carregado em `allClientsData` ou similar, mas aqui é `prospects`)
             // Melhor: buscar o doc para ter certeza
             try {
                // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                const prospectRef = doc(db, `/artifacts/${appId}/public/data/prospects/${prospectId}`);
                const prospectDoc = await getDoc(prospectRef);
                
                if (!prospectDoc.exists()) {
                     console.error("Prospect não encontrado para conversão");
                     return;
                }
                
                const prospect = prospectDoc.data();
                const prospectName = prospect.nome;
                const prospectContact = prospect.telefone || prospect.email || '';

                // Não usamos confirm()
                // Substituído por uma lógica de modal de confirmação (deleteModal)
                document.getElementById('deleteModalText').textContent = `Deseja realmente converter o prospect "${prospectName}" em um novo cliente? O prospect será removido do funil.`;
                currentDeleteInfo = { 
                    collectionName: 'prospects-convert', // Tipo especial
                    docId: prospectId, 
                    data: { nome: prospectName, telefone: prospectContact } 
                };
                showModal('deleteModal');
                
                // O resto da lógica (abrir modal de cliente) acontecerá em `handleConfirmDelete`

             } catch(e) {
                 console.error("Erro ao buscar prospect para converter:", e);
             }
        };
        
        // --- RELATÓRIO FINANCEIRO ---
         
        const loadFinancialReport = () => {
            if (!userId || !db) return;

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            const paymentsQuery = query(collection(db, `/artifacts/${appId}/public/data/payments`));
            onSnapshot(paymentsQuery, (snapshot) => {
                const lateContainer = document.getElementById('late-payments-list');
                const upcomingContainer = document.getElementById('upcoming-payments-list');
                const paidThisMonthContainer = document.getElementById('paid-this-month-list');

                lateContainer.innerHTML = '';
                upcomingContainer.innerHTML = '';
                paidThisMonthContainer.innerHTML = '';

                let hasLate = false;
                let hasUpcoming = false;
                let hasPaidThisMonth = false;

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Zera a hora para comparação de data
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                snapshot.forEach(doc => {
                    const payment = doc.data();
                    const dueDate = new Date(payment.dataVencimento + "T12:00:00"); 
                    dueDate.setHours(0, 0, 0, 0); // Zera a hora
                    const clientName = allClientsData[payment.clientId]?.nome || "Cliente...";

                    const paymentHtml = `
                        <div class="flex justify-between items-center p-3 border rounded-md hover:bg-gray-50">
                            <div>
                                <p class="font-semibold text-gray-800">${clientName} - ${payment.descricao}</p>
                                <p class="text-sm text-gray-600">${formatCurrency(payment.valor)} - Venc: ${formatDate(payment.dataVencimento)}</p>
                            </div>
                            <button onclick="window.handleViewClient('${payment.clientId}')" class="text-sm text-yellow-600 hover:underline">Ver Cliente</button>
                        </div>
                    `;

                    if (payment.status === 'Pendente') {
                        if (dueDate < today) {
                            lateContainer.innerHTML += `<div class="bg-red-50">${paymentHtml}</div>`;
                            hasLate = true;
                        } else {
                            upcomingContainer.innerHTML += `<div class="bg-blue-50">${paymentHtml}</div>`;
                            hasUpcoming = true;
                        }
                    } else if (payment.status === 'Pago') {
                        // Verifica se o pagamento foi feito (ou vencido) no mês/ano atual
                        const paymentDate = new Date(payment.dataVencimento + "T12:00:00");
                        if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                           paidThisMonthContainer.innerHTML += `<div class="bg-green-50">${paymentHtml}</div>`;
                           hasPaidThisMonth = true;
                        }
                    }
                });

                if (!hasLate) lateContainer.innerHTML = '<p class="text-gray-500">Nenhum pagamento atrasado.</p>';
                if (!hasUpcoming) upcomingContainer.innerHTML = '<p class="text-gray-500">Nenhum pagamento previsto.</p>';
                if (!hasPaidThisMonth) paidThisMonthContainer.innerHTML = '<p class="text-gray-500">Nenhum pagamento registrado como pago este mês.</p>';
                
                renderIcons();
            }, (e) => { handleFriendlyError("Erro ao carregar relatório financeiro.", e.message, e); });
        };
        
        // --- TAREFAS GLOBAIS ---
        
        const loadGlobalTasks = () => {
            if (!userId || !db) return;

            const clientFilterSelect = document.getElementById('globalTaskClientFilter');
            const currentValue = clientFilterSelect.value; // Salva o filtro atual
            clientFilterSelect.innerHTML = '<option value="all">Todos os Clientes</option>';
            
            // Ordena os clientes por nome para o dropdown
            const sortedClients = Object.values(allClientsData).sort((a, b) => a.nome.localeCompare(b.nome));
            
            sortedClients.forEach(client => {
                 clientFilterSelect.innerHTML += `<option value="${client.id}">${client.nome}</option>`;
            });
            
            clientFilterSelect.value = currentValue; // Reaplica o filtro
            
            applyGlobalTaskFilters(); 
        };

        const applyGlobalTaskFilters = () => {
            if (!userId || !db) return;

            const selectedClient = document.getElementById('globalTaskClientFilter').value;
            const selectedStatus = document.getElementById('globalTaskStatusFilter').value;
            const container = document.getElementById('global-tasks-list');
            container.innerHTML = '<p class="text-gray-500">Carregando tarefas...</p>'; // Feedback de carregamento

            // CORREÇÃO: Caminho do DB mudou para PÚBLICO
            let q = collection(db, `/artifacts/${appId}/public/data/tasks`);
            let filters = [];

            if (selectedClient !== 'all') {
                filters.push(where("clientId", "==", selectedClient));
            }
            if (selectedStatus !== 'all') {
                filters.push(where("status", "==", selectedStatus));
            }
            
            const filteredQuery = query(q, ...filters);

            onSnapshot(filteredQuery, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa encontrada com os filtros selecionados.</p>';
                    return;
                }
                
                // Ordena as tarefas por cliente
                const tasksData = [];
                snapshot.forEach(doc => {
                    tasksData.push({ id: doc.id, ...doc.data() });
                });
                
                tasksData.sort((a, b) => {
                    const clientNameA = allClientsData[a.clientId]?.nome || 'ZZZ';
                    const clientNameB = allClientsData[b.clientId]?.nome || 'ZZZ';
                    return clientNameA.localeCompare(clientNameB);
                });

                tasksData.forEach(task => {
                    const isDone = task.status === 'Feito';
                    const clientName = allClientsData[task.clientId]?.nome || "Cliente...";

                    container.innerHTML += `
                        <div class="flex justify-between items-center p-4 border rounded-md ${isDone ? 'bg-gray-50' : ''}">
                            <div class="flex items-center gap-3 w-full min-w-0">
                                <input type="checkbox" onchange="window.toggleTaskStatus('${task.id}', ${isDone})" ${isDone ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400 flex-shrink-0">
                                <p class="${isDone ? 'line-through text-gray-500' : 'text-gray-800'} flex-1 truncate" title="${task.descricao}">${task.descricao} <span class="text-xs text-gray-400 whitespace-nowrap">- ${clientName}</span></p>
                            </div>
                            <button onclick="window.handleDeleteClick('tasks', '${task.id}')" class="text-red-600 hover:text-red-800 flex-shrink-0 ml-4"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
                renderIcons();
            }, (e) => { handleFriendlyError("Erro ao filtrar tarefas.", e.message, e); });
        };
        
        // --- MINHA EMPRESA (METAS) ---
        
        const handleGoalsFormSubmit = async (e) => {
            e.preventDefault();
            if (!userId || !db) return;

            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const data = {
                faturamento: parseFloat(document.getElementById('goal-faturamento').value) || 0,
                prospeccao: parseInt(document.getElementById('goal-prospeccao').value) || 0,
                ownerId: userId // Mantém o 'dono'
            };
            
            try {
                await setDoc(goalsDocRef(), data, { merge: true });
                // Não usamos alert()
                loadCompanyGoalsPage(); 
            } catch(e) {
                console.error("Erro ao salvar metas:", e);
                // Não usamos alert()
            } finally {
                submitButton.disabled = false;
            }
        };

        // --- EXCLUSÃO GENÉRICA (MODAL) ---
        
        window.handleDeleteClick = (collectionName, docId) => {
            let data = null; // Inicializa data como null
            if (collectionName === 'clients') {
                 document.getElementById('deleteModalText').textContent = "Tem certeza? Excluir um cliente também excluirá TODOS os seus pagamentos, tarefas e senhas associados. Esta ação é irreversível.";
            } else {
                 document.getElementById('deleteModalText').textContent = "Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.";
            }
            
            // Lógica de `convertProspectToClient` já define `currentDeleteInfo` corretamente.
            // Esta chamada é para exclusões normais.
            if (collectionName !== 'prospects-convert') {
                 currentDeleteInfo = { collectionName, docId, data: null };
                 showModal('deleteModal');
            }
        };
        
        const handleConfirmDelete = async () => {
            if (!currentDeleteInfo || !userId || !db) return;
            
            const { collectionName, docId, data } = currentDeleteInfo;
            
            try {
                if (collectionName === 'clients') {
                    // Excluir Cliente e todos os sub-dados
                    const batch = writeBatch(db);
                    
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    batch.delete(doc(db, `/artifacts/${appId}/public/data/clients/${docId}`));
                    
                    const subCollections = ['payments', 'tasks', 'credentials', 'sales'];
                    for (const subCol of subCollections) {
                        // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                        const q = query(collection(db, `/artifacts/${appId}/public/data/${subCol}`), where("clientId", "==", docId));
                        const snapshot = await getDocs(q);
                        snapshot.forEach(doc => batch.delete(doc.ref));
                    }
                    
                    await batch.commit();
                    
                    if (currentClientId === docId) {
                        showPage('clientsPage');
                    }
                } else if (collectionName === 'prospects-convert') {
                    // Converter Prospect para Cliente
                    await openClientModal(null, data); // Abre o modal de cliente com os dados
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/prospects/${docId}`)); // Deleta o prospect
                
                } else {
                    // Exclusão simples (payments, tasks, credentials, prospects)
                    // CORREÇÃO: Caminho do DB mudou para PÚBLICO
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/${collectionName}/${docId}`));
                }
                
                hideModal('deleteModal');
                currentDeleteInfo = null;
                
            } catch (e) {
                console.error("Erro ao excluir/converter:", e);
                // Não usamos alert()
                hideModal('deleteModal');
                currentDeleteInfo = null;
            }
        };
        
        
        // --- ASSISTENTE IA (REMOVIDO) ---
        /*
        const loadAIPage = () => { ... };
        const handleGenerateAIMessage = async () => { ... };
        const callGeminiAPI = async (userQuery, systemPrompt) => { ... };
        */

        // --- INICIALIZAÇÃO DOS EVENT LISTENERS ---
        
        const initEventListeners = () => {
            
            // Previne múltiplos listeners se onAuthStateChanged disparar mais de uma vez
            if (document.body.dataset.listenersAttached === 'true') {
                return;
            }
            document.body.dataset.listenersAttached = 'true';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageId = e.currentTarget.dataset.page;
                    if (pageId === 'clientsPage') {
                        currentClientId = null;
                    }
                    showPage(pageId);
                });
            });

            // Modais de Cliente
            document.getElementById('showAddClientModalBtn').addEventListener('click', () => openClientModal());
            document.getElementById('editClientBtn').addEventListener('click', () => openClientModal(currentClientId));
            document.getElementById('closeClientModalBtn').addEventListener('click', () => hideModal('clientModal'));
            document.getElementById('clientForm').addEventListener('submit', handleClientFormSubmit);
            document.getElementById('clientPaymentTypeInput').addEventListener('change', (e) => {
                const installmentsInput = document.getElementById('clientInstallmentsInput');
                if (e.target.value === 'parcelado') {
                    installmentsInput.disabled = false;
                    installmentsInput.required = true;
                } else {
                    installmentsInput.disabled = true;
                    installmentsInput.required = false;
                    installmentsInput.value = '';
                }
            });

            // Modais de Prospect
            document.getElementById('showAddProspectModalBtn').addEventListener('click', () => showModal('prospectModal'));
            document.getElementById('closeProspectModalBtn').addEventListener('click', () => hideModal('prospectModal'));
            document.getElementById('prospectForm').addEventListener('submit', handleProspectFormSubmit);

            // Abas (Detalhe Cliente)
            document.querySelectorAll('.tab-link').forEach(link => {
                link.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab, '.tab-link', '.tab-content'));
            });

            // Abas (Financeiro)
            document.querySelectorAll('.finance-tab-link').forEach(link => {
                link.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab, '.finance-tab-link', '.finance-tab-content'));
            });

            // Forms de Detalhe Cliente
            document.getElementById('addPaymentForm').addEventListener('submit', handleAddPaymentSubmit);
            document.getElementById('addTaskForm').addEventListener('submit', handleAddTaskSubmit);
            document.getElementById('addCredentialForm').addEventListener('submit', handleAddCredentialSubmit);

            // Filtros de Tarefas Globais
            document.getElementById('globalTaskClientFilter').addEventListener('change', applyGlobalTaskFilters);
            document.getElementById('globalTaskStatusFilter').addEventListener('change', applyGlobalTaskFilters);

            // Form de Metas
            document.getElementById('goalsForm').addEventListener('submit', handleGoalsFormSubmit);

            // Modal de Exclusão
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                currentDeleteInfo = null;
                hideModal('deleteModal');
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleConfirmDelete);

            // REMOVIDO: Listeners da IA
            // document.getElementById('generateMessageBtn').addEventListener('click', handleGenerateAIMessage);
            // document.getElementById('copyAIBtn').addEventListener('click', () => { ... });
        };
        
        // --- INICIALIZAÇÃO DA PÁGINA ---
        window.addEventListener('load', () => renderIcons()); 
        
    </script>
</body>
</html>

